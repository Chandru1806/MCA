<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Standardized CSV Preview</title>
    <style>
      :root{--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--link:#2563eb;--bg:#ffffff}
      *{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--fg);background:var(--bg);padding:24px;margin:0}
      a{color:var(--link);text-decoration:none}
      a:hover{text-decoration:underline}
      .wrap{max-width:1100px;margin:0 auto}
      .section{margin-top:20px}
      .card{padding:16px;border:1px solid var(--border);border-radius:10px;background:#fff}
      .list{list-style:disc;margin:8px 0 0 22px}
      .list li{margin:6px 0}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
      .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
      .label{font-weight:600}
      select{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
      .hint{font-size:12px;color:var(--muted);margin-top:6px}
      iframe{width:100%;height:520px;border:1px solid var(--border);border-radius:8px;background:#fff}
      .badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#374151}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h2>Standardized CSV</h2>

      <!-- Primary download -->
      <div class="card">
        <div class="controls">
          <span class="label">Active file:</span>
          <select id="filePicker">
            <option value="{{ primary }}" selected>{{ primary }}</option>
            {% if others and others|length %}
              {% for f in others %}
                <option value="{{ f }}">{{ f }}</option>
              {% endfor %}
            {% endif %}
          </select>

          <a id="downloadLink" href="/ingestion/download/{{ primary }}">⬇️ Download current CSV</a>
          <span class="badge">STD</span>
        </div>
        <p class="hint">Use the dropdown to switch which CSV you preview below.</p>
      </div>

      <!-- Other STD outputs (direct links) -->
      {% if others and others|length %}
      <div class="section card">
        <h4 style="margin:0 0 8px;">Other standardized outputs</h4>
        <ul class="list">
          {% for f in others %}
            <li><a class="stdLink" href="/ingestion/download/{{ f }}" data-file="{{ f }}">{{ f }}</a></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Rejects -->
      {% if rejects and rejects|length %}
      <div class="section card">
        <h4 style="margin:0 0 8px;">Rejected rows (needs review)</h4>
        <ul class="list">
          {% for f in rejects %}
            <li><a href="/ingestion/download/{{ f }}">{{ f }}</a> <span class="badge">REJECTS</span></li>
          {% endfor %}
        </ul>
        <p class="hint">Nothing is dropped silently. Review REJECTS, fix issues, and re-upload if needed.</p>
      </div>
      {% endif %}

      <!-- Inline preview -->
      <div class="section card">
        <h4 style="margin:0 0 10px;">Quick preview</h4>
        <iframe id="previewFrame" src="/ingestion/download/{{ primary }}"></iframe>
        <p class="hint">Tip: for the best experience, download and open in Excel.</p>
      </div>

      <div class="section">
        <a href="/ingestion">← Back to upload</a>
      </div>
    </div>

    <script>
      (function(){
        const picker = document.getElementById('filePicker');
        const frame  = document.getElementById('previewFrame');
        const link   = document.getElementById('downloadLink');

        function setActive(file){
          if(!file) return;
          frame.src = '/ingestion/download/' + encodeURIComponent(file);
          link.href = '/ingestion/download/' + encodeURIComponent(file);
        }

        picker.addEventListener('change', function(){
          setActive(this.value);
        });

        // Allow clicking other STD links to switch preview instead of navigating away
        document.querySelectorAll('.stdLink').forEach(a => {
          a.addEventListener('click', function(e){
            e.preventDefault();
            const file = this.dataset.file;
            // update dropdown selection to keep UI consistent
            const opt = Array.from(picker.options).find(o => o.value === file);
            if(opt){ picker.value = file; }
            setActive(file);
          });
        });
      })();
    </script>
  </body>
</html>
